# Metadise Container Images

This repository houses machinery for building container images of the program *Metadise*.
Details regarding Metadise can be found on its [website](https://people.bath.ac.uk/chsscp/teach/metadise.bho/)
and in the [scientific paper](https://doi.org/10.1039/FT9969200433) describing the program.

The `Dockerfile` here builds a container image housing Metadise. The image is intended to
be used as a container-image analogue of the Metadise executable.

## Usage

### Available formats of the container: Docker-format vs. Singularity Image Format

Container images are provided in two different formats. One is the default
format used by [Docker](https://www.docker.com/). This will be referred to here as 'docker
format'. The other is the [Singularity Image Format (SIF)](https://github.com/apptainer/sif)
favoured by [Apptainer](https://apptainer.org/) and [SingularityCE](https://github.com/sylabs/singularity)
(or the predecessor to both, Singularity). Here we assume that users will either want to run docker-format
images on Docker, or SIF-format images on Apptainer (though note that the usage for
SingularityCE is very similar to Apptainer). Below we provide the usage for both cases,
assuming that the user has Docker or Apptainer installed on their system. Moreover we assume
that the user already has basic knowledge of Docker or Apptainer.

### Obtaining an image

Images can be found in the [Packages](https://github.com/orgs/PSDI-UK/packages?repo_name=metadise-container)
section of this GitHub project.
Note that there are two packages, one for the [Docker images](https://github.com/PSDI-UK/metadise-container/pkgs/container/metadise-container%2Fmetadise)
and the other for the [SIF-format images](https://github.com/PSDI-UK/data-transfer-container/pkgs/container/data-transfer-container%2Fdata-transfer). 

#### Docker

Regarding the former, commands are provided [there](https://github.com/PSDI-UK/metadise-container/pkgs/container/metadise-container%2Fmetadise)
to pull a specific version to your local instance of docker, e.g.
```
docker pull ghcr.io/psdi-uk/metadise-container/metadise:v0.0.3
```
After running this command you should be able to see the container image in your local
instance of docker, e.g. by running the `docker images` command.

#### Apptainer

For the SIF images note that, while a command is provided to pull the container to your local
system using Docker, *SIF images will not work with Docker* and hence this command should not be
used. To obtain a SIF image using Apptainer the command is, e.g.

```
apptainer pull oras://ghcr.io/psdi-uk/metadise-container/metadise-sif:v0.0.3
```
This will download the SIF image and store it as a file on your local system in the directory
in which the above command was invoked. Once the container is downloaded, you may wish to
rename the container. The name of the SIF container image used in the rest of this guide is
`metadise.sif`. With this in mind, the command to change the name of the image downloaded
using the command above to `metadise.sif` is
```
mv metadise-sif_v0.0.3.sif metadise.sif
```

### Running the container

#### Docker
An example command is:
```
docker run --user $(id -u):$(id -g) -v ${PWD}:/data ghcr.io/psdi-uk/metadise-container/metadise:v0.0.3
```
This command assumes that the current directory contains your Metadise input files
and is also where you want the Metadise output files to be generated.
Upon instigating this command, the container will execute Metadise in the current
directory, and Metadise output files will be created in that directory.
Upon completion of the Metadise executable the container will terminate.

The purpose of the argument `--user $(id -u):$(id -g)` is to
use the user and group ID of the user on the host within the container. This
ensures that the output files generated by the container belong to the
user who invoked the container, as opposed to, e.g. the root user.

#### Apptainer
Assuming the SIF image has been downloaded as described above and has been named
`metadise.sif`, to invoke the container in the current directory the command is:
```
apptainer run /path/to/sif/file/metadise.sif
```
where `/path/to/sif/file` here is a placeholder for the directory in which the
`metadise.sif` file is located.

As with the Docker container, this command assumes that the current directory
contains your Metadise input files and is also where you want the Metadise output
files to be generated. Upon instigating this command, the container will execute
Metadise in the current directory, and Metadise output files will be created in
that directory. Upon completion of the Metadise executable the container will terminate.


## Building the image

If you have access to the Metadise source code then you can use the `Dockerfile`
here to build a Docker image locally. To do this the command is:
```
docker build -t metadise .
```
where it is assumed that:
1. the image is to be named `metadise`
2. the `Dockerfile` file is in the current directory
3. the source code for Metadise is housed in the subdirectory `metadise_source`

*Note that the source code for Metadise is not provided in this repository.* To
obtain this source code please see Metadise's documentation, links to which
are provided above.


## License

The code in this repository is provided under the conditions
described in the `LICENSE` file in this repository. However, while some of this
code describes container images or processes to build container images,
the software license applicable to these container images will in general not be the
same as `LICENSE`. This is because a container image typically includes binaries
and source code from many pieces of software; the software license for a
container image depends on the licenses of its constituent software.
This should be kept in mind when using any container image linked to this
repository, or any container image built using code in this repository.


# Notes for developers

This repository uses GitHub Actions to implement a CI/CD pipeline which builds, tags
and publishes container images to the GitHub Container Registry linked to this repo
every commit to `main`. The `Dockerfile` is first used to build a Docker-format
container image. This image is in turn used to build a 'sif'-format image (which is
the image format native to Singularity/Apptainer). Both image formats are published
in [Packages](https://github.com/orgs/PSDI-UK/packages?repo_name=metadise-container)

In building the Docker container image the Metadise executable is compiled from
its source code. At the request of the Metadise author, this source code is not
included in this repository in order to keep the code private. Rather, the Metadise
source code is housed in an external private repository which is 'included' in this
repository as a git submodule. This submodule is only 'pulled' into the repo *during* the
CI/CD pipeline, enabling the Metadise source code to be used on the pipeline's runner
to build the Metadise Docker container. In order to be 'included' the submodule during
the pipeline, a personal access token (PAT) is required to access the external
repo housing the Metadise source code. This PAT is a secret for this repository.

